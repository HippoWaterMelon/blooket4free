<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Blooket4Free</title>
    <link rel="stylesheet" href="./assets/css/styles.css">
    <link href="https://fonts.googleapis.com/css?family=Nunito:400,700|Titan+One&display=swap" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.js"></script>
    <style>
        body,
        html {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
        }

        .bodyContainer {
            display: flex;
            width: 100vw;
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
        }

        .leftContainer {
            width: 100%;
        }

        .scrollWrapper {
            width: 100%;
            height: calc(100vh - (2vh + 3vw - 60px));
            /* or whatever fits */
            overflow: auto;
            /* scroll area */
        }

        .packContainer {
            display: grid;
            grid-template-columns: repeat(auto-fill, 210px);
            grid-template-rows: repeat(auto-fill, 210px);
            grid-gap: 25px;
            width: 100%;
            /* height: calc(100vh - (2vh + 3vw + 10px)); */
            justify-content: center;
            overflow: visible;
            padding-bottom: 10px;
        }

        .pack {
            width: 210px;
            height: 210px;
            cursor: pointer;
            position: relative;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: inset 0 -7px rgb(0 0 0 / 20%);
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            transition: .2s;
        }

        .pack:hover {
            transform: scale(.95) translate(-52.5%, -52.5%);
        }

        .pngContainer {
            height: 100%;
            position: relative;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(10deg);
        }

        .pngBg {
            width: 70%;
            filter: brightness(0) invert(100%);
            opacity: .5;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .pngMain {
            width: 65%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .title {
            width: 100%;
            font-size: calc(2vh + 3vw);
            height: calc(2vh + 3vw + 10px);
            font-family: 'Titan One', cursive;
            text-align: center;
            color: #444;
            margin-bottom: 2vw;
        }

        .packWrapper {
            position: relative;
            display: inline-block;
        }

        .packWrapper .tooltip {
            visibility: hidden;
            opacity: 0;
            position: absolute;
            background: rgba(34, 34, 34, 0.8);
            color: #fff;
            padding: 8px 14px;
            border-radius: 7px;
            font-size: 14px;
            line-height: 18px;
            text-align: left;
            transition: opacity 0.2s ease;
            z-index: 999;
            white-space: normal;
            min-width: 160px;
            bottom: 110%;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
        }

        .packWrapper .tooltip::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -6px;
            border-width: 6px;
            border-style: solid;
            border-color: rgba(34, 34, 34, 0.8) transparent transparent transparent;
        }

        .packWrapper .tooltip.below {
            top: 110%;
            bottom: auto;
        }

        .packWrapper .tooltip.below::after {
            top: auto;
            bottom: 100%;
            border-color: transparent transparent rgba(34, 34, 34, 0.8) transparent;
        }

        .packWrapper:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }

        .darkOverlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            /* darkens the pack */
            z-index: 1;
        }

        .lockIcon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40%;
            z-index: 2;
            /* stays above overlay */
        }
    </style>
</head>

<body>
    <div class="scrollWrapper">
        <div class="title">Blooket4Free</div>
        <div class="packContainer" id="packContainer"></div>
        <div style="height: 15px;"></div>
        <div class="packContainer" id="comingSoonContainer"></div>
    </div>
    </div>

    <!-- Unlock Screen -->
    <div id="unlockScreen" style="display:none;">
        <div id="background" class="styles__openBackground___-U4oX-camelCase">
            <img id="cornerIcon" alt="Icon" class="styles__cornerIcon___24o3Z-camelCase" draggable="false">
            <img alt="Icon" class="styles__cornerIcon___24o3Z-camelCase" draggable="false">
            <div id="phaser-canvas" style="position:absolute;top:0;left:0;width:100%;height:100%;z-index:-1;"></div>
            <div class="styles__openContainer___3paFG-camelCase">
                <img id="blookBg" loading="lazy" class="styles__blookBackground___3rt4N-camelCase" draggable="false">
                <div class="styles__blookContainer___36LK2-camelCase styles__unlockedBlookImage___wC4gr-camelCase">
                    <img id="unlockImg" draggable="false" class="styles__blook___1R6So-camelCase" />
                </div>
                <div class="styles__unlockedText___1diat-camelCase">
                    <div class="styles__unlockedBlook___2pr1Z-camelCase" style="font-size:2vw;">
                        <div id="unlockName" style="font-family: Titan One;"></div>
                    </div>
                    <div id="unlockRarity" class="styles__rarityText___1PfSA-camelCase"></div>
                </div>
                <div id="unlockChance" class="styles__bottomText___3_k10-camelCase"></div>
            </div>

            <div class="styles__openPackContainer___2m4Yf-camelCase">
                <div>
                    <img class="styles__packImage___1jX3J-camelCase" id="packBottom">
                    <div class="styles__openPack___3QxCP-camelCase"
                        style="background-image:url('https://blacket.org/content/packSeelOpen.webp');"></div>
                </div>
            </div>

            <!-- Big button -->
            <div class="styles__openBigButton___3KmDM-camelCase styles__canOpen___2znG2-camelCase" role="button"
                tabindex="0"></div>
        </div>
    </div>

    <script src="./assets/js/packdata.js"></script>

    <script>
        let currentResult = null;
        let currentPack = null;
        let opened = false; // track if blook revealed

        function rarityColor(rarity) {
            if (rarity == "Uncommon") return "#2ecc40";
            if (rarity == "Rare") return "rgb(10,20,250)";
            if (rarity == "Epic") return "rgb(190,0,0)";
            if (rarity == "Legendary") return "rgb(255,145,15)";
            if (rarity == "Chroma") return "rgb(0,204,255)";
            if (rarity == "Mystical") return "rgb(163,53,238)";
            return "#444";
        }

        function rollBlook(pack) {
            const roll = Math.random() * 100;
            let cumulative = 0, index = 0;
            for (let i = 0; i < pack.chance.length; i++) {
                cumulative += pack.chance[i];
                if (roll <= cumulative) { index = i; break; }
            }
            return {
                name: pack.blook[index],
                rarity: pack.rarity[index],
                svg: pack.svg[index],
                chance: pack.chance[index]
            };
        }

        function showUnlock(result, pack) {
            currentResult = result;
            currentPack = pack;
            opened = false;

            document.getElementById("unlockName").innerText = result.name;
            document.getElementById("unlockRarity").innerText = result.rarity;
            document.getElementById("unlockRarity").style.color = rarityColor(result.rarity);
            document.getElementById("unlockImg").src = result.svg;
            document.getElementById("unlockChance").innerText = result.chance + "% - NEW!";
            document.getElementById("background").style.background = pack.bg;
            document.getElementById("blookBg").src = pack.blookBackground;
            document.getElementById("cornerIcon").src = pack.cornerIcon;
            document.getElementById("packBottom").src = pack.packBottom;

            const unlockNameElement = document.getElementById("unlockName");
            const unlockContainer = document.querySelector(".styles__unlockedBlook___2pr1Z-camelCase");

            // Add this after setting unlockNameElement.innerText = result.name;
            setTimeout(() => {
                resizeTextToFit(unlockNameElement, unlockContainer);
            }, 10);

            // reset container classes
            const openContainer = document.querySelector(".styles__openContainer___3paFG-camelCase");
            if (openContainer) openContainer.className = "styles__openContainer___3paFG-camelCase";

            // reset pack animation classes
            const packDiv = document.querySelector(".styles__openPack___3QxCP-camelCase");
            if (packDiv) {
                packDiv.style.display = "block";
                packDiv.className = "styles__openPack___3QxCP-camelCase";
            }

            document.getElementById("unlockScreen").style.display = "block";
        }

        function closeUnlock() {
            document.getElementById("unlockScreen").style.display = "none";
            document.getElementById("packContainer").style.display = "grid";
            currentResult = null;
            currentPack = null;
            opened = false;

            // Add this line near the top of closeUnlock()
            const unlockNameElement = document.getElementById("unlockName");
            unlockNameElement.style.fontSize = "2vw";

            // reset pack top animation
            const pack = document.querySelector(".styles__openPack___3QxCP-camelCase");
            if (pack) {
                pack.style.display = "block";
                pack.classList.remove(
                    "styles__isOpeningPack___1qY5t-camelCase"
                );
            }

            // reset pack bottom wiggle
            const packBottom = document.querySelector(".styles__packImage___1jX3J-camelCase");
            if (packBottom) {
                packBottom.classList.remove("styles__wigglingPackBottom___4F3d2-camelCase");
            }

            // reset pack container
            const packContainer = document.querySelector(".styles__openPackContainer___2m4Yf-camelCase");
            if (packContainer) {
                packContainer.classList.remove("styles__openingPackContainer___1ZQzY-camelCase");
            }

            // reset open container
            const openContainer = document.querySelector(".styles__openContainer___3paFG-camelCase");
            if (openContainer) {
                openContainer.className = "styles__openContainer___3paFG-camelCase";
            }

            // reset background
            const background = document.getElementById("background");
            if (background) {
                background.classList.remove("styles__openBackgroundActive___3WzzZ-camelCase");
            }

            // clear particles
            document.getElementById("phaser-canvas").innerHTML = "";
        }

        function playOpenAnimation(rarity) {
            const pack = document.querySelector(".styles__openPack___3QxCP-camelCase");
            const packContainer = document.querySelector(".styles__openPackContainer___2m4Yf-camelCase");
            const openContainer = document.querySelector(".styles__openContainer___3paFG-camelCase");
            const background = document.getElementById("background");
            const packBottom = document.querySelector(".styles__packImage___1jX3J-camelCase");

            if (!pack || !packContainer || !openContainer || !packBottom) return;

            pack.classList.add("styles__isOpeningPack___1qY5t-camelCase");
            packBottom.classList.add("styles__wigglingPackBottom___4F3d2-camelCase");

            pack.addEventListener("animationend", () => {
                // packBottom.classList.remove("styles__wigglingPackBottom___4F3d2-camelCase");
                pack.style.display = "none";
                packContainer.classList.add("styles__openingPackContainer___1ZQzY-camelCase");
                openContainer.className = "styles__openContainer___3paFG-camelCase";
                if (rarity === "uncommon") openContainer.classList.add("styles__openingContainer___2OmG9-camelCase");
                if (rarity === "rare") openContainer.classList.add("styles__openingContainer___2OmG9-camelCase");
                if (rarity === "epic") openContainer.classList.add("styles__openingContainerEpic___3TzCR-camelCase");
                if (rarity === "legendary") openContainer.classList.add("styles__openingContainerLegendary___RbJZ_-camelCase");
                if (rarity === "chroma") openContainer.classList.add("styles__openingContainerChroma___3VBd5-camelCase");
                if (background) background.classList.add("styles__openBackgroundActive___3WzzZ-camelCase");

                setTimeout(() => {
                    document.getElementById("phaser-canvas").innerHTML = "";
                    startParticle(rarity);
                }, 10);

                setTimeout(() => {
                    opened = true;
                }, 400);
            }, { once: true });
        }

        // click anywhere to close once opened
        document.getElementById("background").addEventListener("click", (e) => {
            if (opened) {
                closeUnlock();
            }
        });

        window.addEventListener('resize', () => {
            if (currentResult && document.getElementById("unlockScreen").style.display !== "none") {
                const unlockNameElement = document.getElementById("unlockName");
                const unlockContainer = document.querySelector(".styles__unlockedBlook___2pr1Z-camelCase");
                setTimeout(() => {
                    resizeTextToFit(unlockNameElement, unlockContainer);
                }, 100);
            }
        });

        $(document).ready(function () {
            for (let i = 0; i < packData.length; i++) {
                const wrapper = document.createElement("div");
                wrapper.classList.add("packWrapper");

                const newPack = document.createElement("div");
                newPack.classList.add("pack");
                newPack.style.backgroundImage = packData[i].bg;
                wrapper.appendChild(newPack);

                const pngContainer = document.createElement("div");
                pngContainer.classList.add('pngContainer');
                newPack.appendChild(pngContainer);

                const pngBg = document.createElement("img");
                pngBg.src = packData[i].png;
                pngBg.classList.add('pngBg');
                pngContainer.appendChild(pngBg);

                const pngMain = document.createElement("img");
                pngMain.src = packData[i].png;
                pngMain.classList.add('pngMain');
                pngContainer.appendChild(pngMain);

                // Tooltip
                const tooltip = document.createElement("div");
                tooltip.classList.add("tooltip");

                if (packData[i].comingSoon) {
                    tooltip.innerHTML = "Coming Soon";

                    // Dark overlay
                    const overlay = document.createElement("div");
                    overlay.classList.add("darkOverlay");
                    newPack.appendChild(overlay);

                    // Lock icon
                    const lock = document.createElement("img");
                    lock.src = "./assets/images/lock.svg";
                    lock.classList.add("lockIcon");
                    newPack.appendChild(lock);

                    document.getElementById("comingSoonContainer").appendChild(wrapper);
                } else {
                    // Normal tooltip
                    let tooltipHtml = "<strong>Pack Rates:</strong><br>";
                    for (let j = 0; j < packData[i].blook.length; j++) {
                        tooltipHtml += `${packData[i].blook[j]}: ${packData[i].chance[j]}%<br>`;
                    }
                    tooltip.innerHTML = tooltipHtml;

                    // Click event for active packs
                    newPack.addEventListener("click", function () {
                        const result = rollBlook(packData[i]);
                        document.getElementById("packContainer").style.display = "none";
                        showUnlock(result, packData[i]);
                    });

                    // append to active packs
                    document.getElementById("packContainer").appendChild(wrapper);
                }

                wrapper.appendChild(tooltip);

                wrapper.addEventListener("mouseenter", () => {
                    const rect = wrapper.getBoundingClientRect();
                    if (rect.top < 100) {
                        tooltip.classList.add("below");
                    } else {
                        tooltip.classList.remove("below");
                    }
                });
            }
        });

        // Bind big open button
        const openButton = document.querySelector(".styles__openBigButton___3KmDM-camelCase");
        if (openButton) {
            openButton.addEventListener("click", () => {
                if (currentResult) {
                    playOpenAnimation(currentResult.rarity.toLowerCase());
                }
            });
        }

        function resizeTextToFit(textElement, containerElement) {
            const container = containerElement || textElement.parentElement;
            const maxWidth = container.offsetWidth * 0.95; // Leave 5% padding
            const maxHeight = container.offsetHeight * 0.9; // Leave 10% padding for vertical space

            // Start with the initial font size (2vw converted to pixels)
            let fontSize = window.innerWidth * 0.02; // 2vw in pixels
            textElement.style.fontSize = fontSize + 'px';

            // Reduce font size until text fits within container
            while ((textElement.scrollWidth > maxWidth || textElement.scrollHeight > maxHeight) && fontSize > 8) {
                fontSize -= 0.5;
                textElement.style.fontSize = fontSize + 'px';
            }

            // Ensure minimum readable size
            if (fontSize < 12) {
                fontSize = 12;
                textElement.style.fontSize = fontSize + 'px';
            }
        }
    </script>

    <script src="./assets/js/particles.js"></script>

    <script>
        window.addEventListener('beforeunload', function (e) {
            e.preventDefault(); 
            e.returnValue = ''; 
        });
    </script>
</body>

</html>
