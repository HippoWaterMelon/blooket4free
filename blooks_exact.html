<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>My Blooks (exact)</title>

  <!-- same site stylesheets so classes/style match exactly -->
  <link rel="preload" as="image" href="https://ac.blooket.com/marketassets/blooks/lightblue.svg">
  <link rel="preload" as="image" href="https://ac.blooket.com/marketassets/blooks/purple.svg">
  <link rel="preload" as="image" href="https://ac.blooket.com/marketassets/blooks/elfsweatersnowman.svg">

  <link rel="stylesheet"
    href="https://ac.blooket.com/dashboard/ee3082e9bdda941fdd8418c7b00c1d2ee1cd3a73/_next/static/css/121a1462914990a5.css"
    data-precedence="next">
  <link rel="stylesheet"
    href="https://ac.blooket.com/dashboard/ee3082e9bdda941fdd8418c7b00c1d2ee1cd3a73/_next/static/css/7d2a7f4491889bcd.css"
    data-precedence="next">
  <link rel="stylesheet"
    href="https://ac.blooket.com/dashboard/ee3082e9bdda941fdd8418c7b00c1d2ee1cd3a73/_next/static/css/43cb5a8b08a4fd81.css"
    data-precedence="next">
  <link rel="stylesheet"
    href="https://ac.blooket.com/dashboard/ee3082e9bdda941fdd8418c7b00c1d2ee1cd3a73/_next/static/css/a0406186fc01ce56.css"
    data-precedence="next">
  <link rel="stylesheet"
    href="https://ac.blooket.com/dashboard/ee3082e9bdda941fdd8418c7b00c1d2ee1cd3a73/_next/static/css/453191536c2b89e6.css"
    data-precedence="next">
  <link rel="stylesheet"
    href="https://ac.blooket.com/dashboard/ee3082e9bdda941fdd8418c7b00c1d2ee1cd3a73/_next/static/css/51e88ac748998e08.css"
    data-precedence="next">

  <style>
    /* preserve layout centering + hide token counter per your request */

    .TokenCounter_tokenContainer__wE6XL {
      display: none !important;
    }

    /* hide the template node itself */
    #blook-modal-template {
      display: none;
    }
  </style>
</head>

<!-- keep the exact body classes from your working file so Titan + font variables load -->

<body class="__variable_b724e5 __variable_f9d1f4">

  <main class="layout_main__mXTwS">
    <div class="page_wrapper___woS4" data-sentry-component="Blooks">
      <!-- keep the original background wrapper unchanged -->
      <div class="_background_l90pt_1" style="background:linear-gradient(#0bc2cf,#349aef)">
        <div class="_checkers_l90pt_12" style="background-size:1000px"></div>
      </div>

      <h1 class="BlooksWrapper_header__OMK6W">My Blooks</h1>

      <div class="BlooksWrapper_content__wfMjd">
        <div class="BlooksWrapper_container___qLk4">
          <div class="BlooksHeader_row__D7cwg" data-sentry-component="BlooksHeader">
            <div class="BlooksHeader_buttons__0DDTc">
              <label class="BlooksHeader_button__I4Kms">
                <input id="toggle-free" type="checkbox" name="free" checked>
                <span class="BlooksHeader_checkmark__Zztu9"></span>
                Show Free Blooks
              </label>

              <label class="BlooksHeader_button__I4Kms">
                <input id="toggle-packs" type="checkbox" name="packs" checked>
                <span class="BlooksHeader_checkmark__Zztu9"></span>
                Show Packs
              </label>
            </div>
          </div>

          <div class="BlooksPacks_container__nayTq" data-sentry-component="BlooksPacksContainer">
            <div id="packs-scroll" class="BlooksPacks_scrollbox__SPjLM"></div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- modal TEMPLATE (hidden) â€” structure matches your Horse popup exactly:
     left column = _blookContainer_inzvw_1 (blook), below it modal-bg img,
     right column = modal info (name, pack, rarity with small icon, description).
-->
  <div id="blook-modal-template">
    <div class="_modal_fhi6r_13 BlookModal_blookModal__kZ5LX">
      <button type="button" class="_closeIcon_fhi6r_70" aria-label="Close">
        <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="times"
          class="svg-inline--fa fa-times fa-w-11 " viewBox="0 0 352 512" xmlns="http://www.w3.org/2000/svg">
          <path fill="currentColor"
            d="M242.72 256l100.07-100.07c12.28-12.28 12.28-32.19 0-44.48l-22.24-22.24c-12.28-12.28-32.19-12.28-44.48 0L176 189.28 75.93 89.21c-12.28-12.28-32.19-12.28-44.48 0L9.21 111.45c-12.28 12.28-12.28 32.19 0 44.48L109.28 256 9.21 356.07c-12.28 12.28-12.28 32.19 0 44.48l22.24 22.24c12.28 12.28 32.2 12.28 44.48 0L176 322.72l100.07 100.07c12.28 12.28 32.2 12.28 44.48 0l22.24-22.24c12.28-12.28 12.28-32.19 0-44.48L242.72 256z">
          </path>
        </svg>
        <span class="_srOnly_fhi6r_86">Close</span>
      </button>

      <div class="BlookModal_modalWrapper__TnRyt">
        <div class="BlookModal_modalBlook__y3uOR" data-sentry-component="BlookModalImage">
          <div class="_blookContainer_inzvw_1" data-tooltip-id="blook-tooltip"
            style="width:140px; z-index: var(--z-index-top);">
            <img class="_blook_inzvw_1" id="modal-img" src="" alt="" draggable="false">
          </div>
          <img id="modal-bg" class="BlookModal_blookBackground__azqLO" src="" alt="">
        </div>

        <form class="BlookModal_modalForm__PdjL_" action="javascript:;">
          <input type="hidden" name="blook" value="">
          <div class="BlookModal_modalInfo__Z2VdS" id="modal-info"></div>
        </form>
      </div>
    </div>
  </div>

  <script src="./assets/js/freepackdata.js"></script>
  <script src="./assets/js/packdata.js"></script>

  <script>
    /* tiny helpers */
    function esc(s) { if (s == null) return ''; return String(s).replace(/[&<>"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c])); }
    function normRarity(r) { return r ? String(r).trim().replace(/\s+/g, '') : 'Common'; }

    document.addEventListener('DOMContentLoaded', function () {
      const packsScroll = document.getElementById('packs-scroll');
      const chkFree = document.getElementById('toggle-free');
      const chkPacks = document.getElementById('toggle-packs');
      const modalTemplate = document.querySelector('#blook-modal-template > div');

      const freeArr = (typeof freePackData !== 'undefined' && Array.isArray(freePackData)) ? freePackData : [];
      const packArr = (typeof packData !== 'undefined' && Array.isArray(packData)) ? packData : [];
      const allPacks = [
        ...freeArr.map(p => (Object.assign({}, p, { _isFree: true }))),
        ...packArr.map(p => (Object.assign({}, p, { _isFree: false })))
      ];

      function createTile(name, img, rarity, pIdx, bIdx) {
        const rn = normRarity(rarity || 'Common');
        const root = document.createElement('div');
        root.className = 'BlookModal_blook__h0dTV';
        root.dataset.pack = String(pIdx);
        root.dataset.index = String(bIdx);

        // badge before button for correct overlap
        const badge = document.createElement('div');
        badge.className = 'BlookModal_quantity__BiP_5';
        badge.style.backgroundColor = `var(--${rn})`;
        badge.textContent = '999';

        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'BlookModal_blookButton__hSYIJ';

        const inner = document.createElement('div');
        inner.className = '_blookContainer_inzvw_1';
        inner.setAttribute('data-tooltip-id', 'blook-tooltip');

        const imgEl = document.createElement('img');
        imgEl.className = '_blook_inzvw_1';
        imgEl.draggable = false;
        imgEl.src = img || '';
        imgEl.alt = name || '';

        inner.appendChild(imgEl);
        btn.appendChild(inner);

        root.appendChild(badge);
        root.appendChild(btn);
        return root;
      }

      function render() {
        packsScroll.innerHTML = '';
        const showFree = chkFree ? chkFree.checked : true;
        const grouped = chkPacks ? chkPacks.checked : true;

        if (!grouped) {
          const grid = document.createElement('div');
          grid.className = 'BlooksPacks_blooks__ocBoL';
          allPacks.forEach((pack, pIdx) => {
            if (pack._isFree && !showFree) return;
            const names = Array.isArray(pack.blook) ? pack.blook : (Array.isArray(pack.blooks) ? pack.blooks : []);
            const svgs = Array.isArray(pack.svg) ? pack.svg : (Array.isArray(pack.svgs) ? pack.svgs : []);
            const rarities = Array.isArray(pack.rarity) ? pack.rarity : [];
            names.forEach((entry, i) => {
              let name = '', img = '', rarity = 'Common';
              if (typeof entry === 'string') { name = entry; img = svgs[i] || ''; rarity = rarities[i] || pack.rarity || 'Common'; }
              else { name = entry.name || entry.title || ''; img = entry.svg || entry.image || svgs[i] || ''; rarity = entry.rarity || rarities[i] || pack.rarity || 'Common'; }
              grid.appendChild(createTile(name, img, rarity, pIdx, i));
            });
          });
          packsScroll.appendChild(grid);
          return;
        }

        // grouped
        allPacks.forEach((pack, pIdx) => {
          if (pack._isFree && !showFree) return;
          const names = Array.isArray(pack.blook) ? pack.blook : (Array.isArray(pack.blooks) ? pack.blooks : []);
          if (!names.length) return;
          const svgs = Array.isArray(pack.svg) ? pack.svg : (Array.isArray(pack.svgs) ? pack.svgs : []);
          const rarities = Array.isArray(pack.rarity) ? pack.rarity : [];
          const packDiv = document.createElement('div');
          packDiv.className = 'BlooksPacks_pack___MJtt';
          // tileBackground may be a gradient or a url
          let bg = pack.tileBackground || pack.bg || '';
          if (bg && !String(bg).trim().startsWith('linear-gradient')) bg = `url('${esc(bg)}')`;
          packDiv.innerHTML = `
        <div class="BlooksPacks_textureHeader__1ecGZ">
          <div class="BlooksPacks_texture__7_8Gf" style="background-image:${bg}"></div>
          <h2 class="BlooksPacks_title__qiDcM">${esc(pack.name || pack.title || '')}</h2>
        </div>
        <div class="BlooksPacks_divider__mT_iM"></div>
        <div class="BlooksPacks_blooks__ocBoL"></div>`;
          const container = packDiv.querySelector('.BlooksPacks_blooks__ocBoL');
          names.forEach((entry, i) => {
            let name = '', img = '', rarity = 'Common';
            if (typeof entry === 'string') { name = entry; img = svgs[i] || ''; rarity = rarities[i] || pack.rarity || 'Common'; }
            else { name = entry.name || entry.title || ''; img = entry.svg || entry.image || svgs[i] || ''; rarity = entry.rarity || rarities[i] || pack.rarity || 'Common'; }
            container.appendChild(createTile(name, img, rarity, pIdx, i));
          });
          packsScroll.appendChild(packDiv);
        });
      }

      /* Open modal inline below the pack's blooks container and copy that container's background */
      function openModal(packIdx, bIdx, clickedTile) {
        closeModal();

        const pack = allPacks[Number(packIdx)];
        if (!pack) return;
        const names = Array.isArray(pack.blook) ? pack.blook : (Array.isArray(pack.blooks) ? pack.blooks : []);
        const svgs = Array.isArray(pack.svg) ? pack.svg : (Array.isArray(pack.svgs) ? pack.svgs : []);
        const rarities = Array.isArray(pack.rarity) ? pack.rarity : [];
        const descs = Array.isArray(pack.blookDesc) ? pack.blookDesc : (Array.isArray(pack.descs) ? pack.descs : []);
        const entry = names[Number(bIdx)];
        if (!entry) return;

        let name = '', imgSrc = '', rarity = 'Common', desc = '';
        if (typeof entry === 'string') { name = entry; imgSrc = svgs[bIdx] || ''; rarity = rarities[bIdx] || pack.rarity || 'Common'; desc = descs[bIdx] || ''; }
        else { name = entry.name || entry.title || ''; imgSrc = entry.svg || entry.image || svgs[bIdx] || ''; rarity = entry.rarity || rarities[bIdx] || pack.rarity || 'Common'; desc = entry.description || entry.desc || descs[bIdx] || ''; }

        // find the pack's blooks container (this is the purple box the tiles sit in)
        const packDiv = clickedTile.closest('.BlooksPacks_pack___MJtt');
        const blooksContainer = packDiv ? packDiv.querySelector('.BlooksPacks_blooks__ocBoL') : clickedTile.closest('.BlooksPacks_blooks__ocBoL');

        // clone modal template and populate
        const clone = modalTemplate.cloneNode(true);
        const modalImg = clone.querySelector('#modal-img');
        const modalBg = clone.querySelector('#modal-bg');
        const modalBlook = clone.querySelector('.BlookModal_modalBlook__y3uOR');
        const modalInfo = clone.querySelector('#modal-info');

        if (modalImg) { modalImg.src = imgSrc || ''; modalImg.alt = name || ''; }

        // if tileBackground is an image url, use it for modal-bg <img> (sits under the blook)
        // else if pack has gradient (linear-gradient...), apply that directly to the modalBlook container
        const bgVal = pack.blookBackground || pack.tileBackground || pack.bg || '';
        if (bgVal && String(bgVal).trim().startsWith('linear-gradient')) {
          if (modalBlook) modalBlook.style.backgroundImage = bgVal;
          if (modalBg) { modalBg.style.display = 'none'; modalBg.src = ''; }
        } else if (bgVal) {
          if (modalBg) { modalBg.style.display = ''; modalBg.src = bgVal; modalBg.alt = pack.name || ''; }
          if (modalBlook) modalBlook.style.backgroundImage = '';
        } else {
          if (modalBg) { modalBg.style.display = 'none'; modalBg.src = ''; }
          if (modalBlook) modalBlook.style.backgroundImage = '';
        }

        // fill info (includes small rarity icon like the horse popup)
        const rarityIcon = 'https://ac.blooket.com/dashboard/ee3082e9bdda941fdd8418c7b00c1d2ee1cd3a73/_next/static/media/common.38546a9e.svg';
        if (modalInfo) {
          modalInfo.innerHTML = `
        <h2>${esc(name)}</h2>
        <h3>${esc(pack.name || pack.title || '')}</h3>
        <div class="BlookModal_tags__My798">
          <span class="BlookModal_tag__iidYw">
            <img alt="${esc(rarity)}" draggable="false" loading="lazy" width="20" height="25" src="${rarityIcon}" style="color: transparent; margin: 0px 5px 0px -3px;">
            ${esc(rarity)}
          </span>
        </div>
        <div class="BlookModal_description__tq3g">${esc(desc || '')}</div>
      `;
        }

        // wire close button
        const closeBtn = clone.querySelector('._closeIcon_fhi6r_70');
        if (closeBtn) closeBtn.addEventListener('click', closeModal);

        // **copy computed background & width from the blooks container so the modal visually matches**
        if (clickedTile) {
          clickedTile.appendChild(clone);  // nest inside the tile
        } else if (blooksContainer) {
          blooksContainer.appendChild(clone);
        }

        // register outside-click close after a tick so the click that opened the modal doesn't immediately close it
        setTimeout(() => document.addEventListener('click', outsideClickClose), 0);
      }

      function closeModal() {
        const m = document.querySelector('._modal_fhi6r_13.BlookModal_blookModal__kZ5LX');
        if (m) m.remove();
        document.removeEventListener('click', outsideClickClose);
      }

      function outsideClickClose(e) {
        const m = document.querySelector('._modal_fhi6r_13.BlookModal_blookModal__kZ5LX');
        if (m && !m.contains(e.target) && !e.target.closest('.BlookModal_blook__h0dTV')) {
          closeModal();
        }
      }

      // tile click delegation
      packsScroll.addEventListener('click', function (ev) {
        const tile = ev.target.closest('.BlookModal_blook__h0dTV');
        if (!tile) return;
        openModal(tile.dataset.pack, tile.dataset.index, tile);
      });

      // toggles
      if (chkFree) chkFree.addEventListener('change', render);
      if (chkPacks) chkPacks.addEventListener('change', render);

      // Esc closes
      document.addEventListener('keydown', function (e) { if (e.key === 'Escape') closeModal(); });

      // initial paint
      render();
    });
  </script>
</body>

</html>